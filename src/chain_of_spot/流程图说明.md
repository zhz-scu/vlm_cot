# Chain-of-Spot 流程图说明

## 🔄 整体流程

```
用户输入图片和问题
        ↓
   第一步：定位ROI
        ↓
   第二步：裁剪ROI
        ↓
   第三步：详细分析
        ↓
   输出最终答案
```

## 📋 详细步骤说明

### 第一步：定位ROI (Region of Interest)
```
输入：整张图片 + 问题
处理：AI分析问题，找到关键区域
输出：ROI坐标 [x0,x1,y0,y1]
```

**具体过程**：
1. AI读取图片和问题
2. 分析问题中的关键词（颜色、形状、位置等）
3. 在图片中寻找匹配的区域
4. 返回精确的坐标位置

**示例**：
```
问题："红色汽车在哪里？"
关键词：红色、汽车
AI思考：寻找红色汽车的位置
结果：[0.6, 0.9, 0.5, 0.8] (右下角区域)
```

### 第二步：裁剪ROI
```
输入：原始图片 + ROI坐标
处理：根据坐标裁剪出关键区域
输出：ROI图片
```

**具体过程**：
1. 根据ROI坐标确定裁剪区域
2. 从原图中提取该区域
3. 保持ROI图片的清晰度
4. 为ROI添加适当的上下文边界

**示例**：
```
ROI坐标：[0.6, 0.9, 0.5, 0.8]
裁剪结果：包含红色汽车的局部图片
```

### 第三步：详细分析
```
输入：原图 + ROI图片 + 问题
处理：AI结合全局和局部信息进行分析
输出：详细的答案
```

**具体过程**：
1. AI同时查看原图和ROI图片
2. 结合全局上下文和局部细节
3. 生成详细的描述
4. 提供准确的位置和特征信息

**示例**：
```
输入：原图 + ROI图片 + "红色汽车在哪里？"
分析：结合全局位置和局部细节
输出："红色汽车位于图像右下角，是一辆跑车，颜色鲜艳..."
```

## 🎯 关键概念解释

### ROI (Region of Interest)
- **定义**：感兴趣的区域，即问题相关的关键部分
- **作用**：让AI专注于重要区域，忽略无关信息
- **表示**：用坐标 [x0,x1,y0,y1] 表示，范围0-1

### 坐标系统
```
图片坐标系：
(0,0) -------- (1,0)
   |              |
   |              |
   |              |
(0,1) -------- (1,1)

ROI坐标 [x0,x1,y0,y1]：
- x0: 左边界位置
- x1: 右边界位置  
- y0: 上边界位置
- y1: 下边界位置
```

### 推理轨迹
记录AI的思考过程：
1. **指令1**：要求AI定位ROI
2. **响应1**：AI的定位结果
3. **ROI提取**：从响应中提取坐标
4. **指令2**：要求AI详细分析
5. **最终答案**：AI的详细回答

## 🔍 不同场景的流程

### 场景1：位置问题
```
问题："红色汽车在哪里？"
流程：
1. 定位 → 找到红色汽车位置
2. 裁剪 → 提取汽车区域
3. 分析 → 描述位置和特征
结果："红色汽车位于右下角..."
```

### 场景2：特征问题
```
问题："这个物体的形状是什么？"
流程：
1. 定位 → 找到目标物体
2. 裁剪 → 提取物体区域
3. 分析 → 详细描述形状
结果："这是一个圆形，直径约..."
```

### 场景3：细节问题
```
问题："图片右下角有什么？"
流程：
1. 定位 → 确定右下角区域
2. 裁剪 → 提取该区域
3. 分析 → 描述区域内容
结果："右下角有一个蓝色圆形..."
```

## ⚡ 优化机制

### 多级ROI提取
```
第一级：文本解析
- 从AI回答中提取坐标
- 支持多种格式：[x,y,w,h], (x,y,x,y) 等

第二级：注意力分析
- 基于问题关键词定位
- 颜色、形状、位置匹配

第三级：启发式规则
- 使用预设规则
- 默认中心区域
```

### 置信度评估
```
评估因素：
1. ROI大小：适中大小得分高
2. 答案质量：详细答案得分高
3. 格式正确：标准坐标得分高

置信度范围：0-1
- 0.8-1.0：高置信度
- 0.6-0.8：中等置信度
- 0.0-0.6：低置信度
```

## 🎨 可视化输出

### ROI可视化
```
输入：原图 + ROI坐标
处理：在原图上绘制边界框
输出：标记ROI的图片

效果：
- 红色矩形框标记ROI区域
- 清晰显示AI关注的区域
- 便于验证定位准确性
```

### 推理轨迹可视化
```
格式：
1. 指令1: [具体指令内容]
2. 响应1: [AI的响应]
3. ROI区域: [坐标信息]
4. 指令2: [详细分析指令]
5. 最终答案: [详细回答]
```

## 🔧 技术实现细节

### 模型调用流程
```
1. 构建消息格式
2. 应用聊天模板
3. 处理视觉信息
4. 准备模型输入
5. 执行推理生成
6. 解码输出结果
```

### 错误处理机制
```
ROI提取失败：
1. 尝试文本解析
2. 使用注意力分析
3. 应用启发式规则
4. 使用默认ROI

模型调用失败：
1. 重试机制
2. 降级处理
3. 错误日志记录
```

## 📊 性能指标

### 准确性指标
- **ROI定位精度**：坐标准确性
- **答案质量**：描述的详细程度
- **推理逻辑**：思考过程的合理性

### 效率指标
- **推理速度**：处理时间
- **内存使用**：资源消耗
- **成功率**：成功处理的比例

### 用户体验指标
- **可视化质量**：ROI标记的清晰度
- **可解释性**：推理轨迹的可读性
- **交互性**：用户反馈的响应性

---

**通过这个流程图，你可以清楚地了解 Chain-of-Spot 是如何工作的！** 🚀
